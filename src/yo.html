<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spotify Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background-color:#121212;color:#fff;overflow-x:hidden}
    .app-container{display:flex;flex-direction:column;min-height:100vh;padding:20px;padding-bottom:70px}
    .container{max-width:100%}
    h1,h2{color:#1DB954;margin:15px 0;padding:0 15px}
    .section{margin-bottom:20px}
    .carousel-container{position:relative;overflow:hidden;padding-bottom:20px}
    .carousel{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;padding:0 15px;gap:15px}
    .carousel::-webkit-scrollbar{display:none}
    .card{flex:0 0 180px;background-color:#1e1e1e;border-radius:8px;overflow:hidden;scroll-snap-align:start;transition:transform .2s;cursor:pointer}
    .card:hover{transform:scale(1.03)}
    .card img{width:100%;height:180px;object-fit:cover}
    .card-content{padding:10px}
    .card-content h3{margin:0 0 8px 0;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff}
    .embed-container{position:relative;padding-bottom:100%;height:0;overflow:hidden;margin-top:10px;border-radius:8px}
    .embed-container iframe{position:absolute;top:0;left:0;width:100%;height:100%}
    .loading{text-align:center;padding:20px;color:#aaa}
    .view{display:none}
    .view.active{display:block}
    .search-container{display:flex;align-items:center;background-color:#2d2d2d;border-radius:20px;padding:8px 15px;margin:15px;color:#fff}
    .search-container input{border:none;background:transparent;color:#fff;flex:1;outline:none;padding:5px}
    .search-container button{background:none;border:none;color:#fff;cursor:pointer}
    .panel{margin:15px;background-color:#1e1e1e;border-radius:8px;padding:15px}
    .search-results{display:none}
    .search-results.show{display:block}
    .result-item{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;border-radius:5px;background-color:#2d2d2d}
    .result-item img{width:50px;height:50px;border-radius:5px;object-fit:cover}
    .result-item-info h3{font-size:16px;margin-bottom:5px}
    .result-item-info p{font-size:14px;color:#b3b3b3;margin:0}
    .btn{border:none;border-radius:20px;padding:6px 14px;cursor:pointer;font-weight:600;background-color:#1DB954;color:#fff;white-space:nowrap}
    .btn.secondary{background-color:#444}
    .btn:active{transform:scale(.98)}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;align-items:center;background-color:#121212;border-top:1px solid #333;padding:10px 0;z-index:1000}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:#b3b3b3;text-decoration:none;padding:8px 15px}
    .nav-item.active{color:#1db954}
    .nav-item i{font-size:24px;margin-bottom:5px}
    .nav-item span{font-size:12px}
    @media (min-width:768px){
      .card{flex:0 0 200px}
      .card img{height:200px}
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="container">
      <div id="homeView" class="view active">
        <h1>Spotify Dashboard</h1>

        <div class="section">
          <h2>Trending Songs</h2>
          <div class="carousel-container"><div class="carousel" id="trendingSongs"></div></div>
        </div>

        <div class="section">
          <h2>Popular Artists</h2>
          <div class="carousel-container"><div class="carousel" id="popularArtists"></div></div>
        </div>

        <div class="section">
          <h2>Popular Albums</h2>
          <div class="carousel-container"><div class="carousel" id="popularAlbums"></div></div>
        </div>

        <div class="section">
          <h2>Popular Radio</h2>
          <div class="carousel-container"><div class="carousel" id="popularRadio"></div></div>
        </div>

        <div class="section">
          <h2>Featured Charts</h2>
          <div class="carousel-container"><div class="carousel" id="featuredCharts"></div></div>
        </div>
      </div>

      <div id="searchView" class="view">
        <h1>Search</h1>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Search for songs...">
          <button id="searchButton"><i class="fas fa-search"></i></button>
        </div>
        <div class="panel search-results" id="searchResults"></div>
      </div>

      <div id="downloadView" class="view">
        <h1>Downloader</h1>
        <div class="panel">
          <div style="color:#b3b3b3;margin-bottom:10px;line-height:1.4;">
            Download Songs, Playlists, Albums &amp; Artist Songs from Spotify
          </div>
          <div class="search-container" style="margin:0;">
            <input type="text" id="downloadUrlInput" placeholder="Paste Spotify URL here...">
            <button id="downloadBtn" title="Download"><i class="fas fa-download"></i></button>
          </div>
          <div id="downloadStatus" class="loading" style="padding:12px 0;display:none;"></div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn secondary" id="openDownloadBtn">Open Download</button>
            <button class="btn secondary" id="clearDownloadBtn">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <a href="#" class="nav-item active" data-view="homeView">
        <i class="fas fa-home"></i><span>Home</span>
      </a>
      <a href="#" class="nav-item" data-view="searchView">
        <i class="fas fa-search"></i><span>Search</span>
      </a>
      <a href="#" class="nav-item" data-view="downloadView">
        <i class="fas fa-download"></i><span>Download</span>
      </a>
    </div>
  </div>

  <script>
    let lastDownloadLink=""

    async function fetchHomeData(){
      try{
        const response=await fetch("https://betadash-api-swordslush-production.up.railway.app/spotify/home")
        const data=await response.json()
        return data.results||null
      }catch(e){
        console.error(e)
        return null
      }
    }

    function getFirstTruthy(){
      for(let i=0;i<arguments.length;i++){
        const v=arguments[i]
        if(v!==undefined&&v!==null&&String(v).trim()!=="")return v
      }
      return null
    }

    function buildSpotifyEmbedFromUrl(url){
      if(!url||typeof url!=="string")return null
      try{
        const u=new URL(url)
        const host=u.hostname.replace(/^www\./,"")
        if(!host.includes("open.spotify.com"))return null
        const parts=u.pathname.split("/").filter(Boolean)
        if(parts.length>=2){
          return `https://open.spotify.com/embed/${parts[0]}/${parts[1]}`
        }
        return null
      }catch(e){
        return null
      }
    }

    function resolveCardFields(item,isRadio){
      const title=getFirstTruthy(item.title,item.name,"Untitled")
      const href=getFirstTruthy(item.href,item.url,item.externalUrl,item.shareUrl,item.link)
      const image=getFirstTruthy(isRadio?item.image:null,item.thumbnail,item.image,item.cover,item?.images?.[0]?.url)
      const embedUrl=getFirstTruthy(isRadio?item.playlist:null,item.embedUrl,item.embed,item.playlist,item.uri?`https://open.spotify.com/embed?uri=${encodeURIComponent(item.uri)}`:null,buildSpotifyEmbedFromUrl(href))
      return {title,href,image,embedUrl}
    }

    function renderCards(containerId,items,isRadio){
      const container=document.getElementById(containerId)
      container.innerHTML=""
      if(!items||!Array.isArray(items)||items.length===0){
        container.innerHTML='<div class="loading">No items.</div>'
        return
      }
      items.forEach(item=>{
        const f=resolveCardFields(item,!!isRadio)
        const card=document.createElement("div")
        card.className="card"
        card.onclick=()=>{if(f.href)window.open(f.href,"_blank")}
        const safeImg=f.image||"https://via.placeholder.com/300x300?text=Spotify"
        const embedHtml=f.embedUrl?`<div class="embed-container"><iframe src="${f.embedUrl}" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe></div>`:`<div class="loading" style="padding:10px 0;">No preview</div>`
        card.innerHTML=`<img src="${safeImg}" alt="${f.title}"><div class="card-content"><h3 title="${f.title}">${f.title}</h3>${embedHtml}</div>`
        container.appendChild(card)
      })
    }

    async function initDashboard(){
      document.querySelectorAll(".carousel").forEach(c=>c.innerHTML='<div class="loading">Loading...</div>')
      const results=await fetchHomeData()
      if(results){
        renderCards("trendingSongs",results.trendingSongs,false)
        renderCards("popularArtists",results.popularArtists,false)
        renderCards("popularAlbums",results.popularAlbums,false)
        renderCards("popularRadio",results.popularRadio,true)
        renderCards("featuredCharts",results.featuredCharts,false)
      }else{
        document.querySelectorAll(".carousel").forEach(c=>c.innerHTML='<div class="loading">Failed to load.</div>')
      }
    }

    function setActiveView(viewId){
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"))
      document.getElementById(viewId).classList.add("active")
      document.querySelectorAll(".nav-item").forEach(nav=>nav.classList.remove("active"))
      const a=document.querySelector(`.nav-item[data-view="${viewId}"]`)
      if(a)a.classList.add("active")
      if(viewId==="searchView")document.getElementById("searchInput").focus()
      if(viewId==="downloadView")document.getElementById("downloadUrlInput").focus()
    }

    document.querySelectorAll(".nav-item").forEach(item=>{
      item.addEventListener("click",e=>{
        e.preventDefault()
        setActiveView(item.getAttribute("data-view"))
      })
    })

    function showDownloadStatus(msg,show){
      const el=document.getElementById("downloadStatus")
      el.textContent=msg||""
      el.style.display=show?"block":"none"
    }

    function normalizeTracks(data){
      if(!data)return []
      if(Array.isArray(data))return data
      if(Array.isArray(data.tracks))return data.tracks
      if(Array.isArray(data.results))return data.results
      if(Array.isArray(data.data))return data.data
      if(data.data&&Array.isArray(data.data.tracks))return data.data.tracks
      if(data.data&&Array.isArray(data.data.results))return data.data.results
      return []
    }

    function trackField(track,key){
      return getFirstTruthy(track[key],track?.data?.[key],track?.track?.[key])
    }

    document.getElementById("searchButton").addEventListener("click",async()=>{
      const q=document.getElementById("searchInput").value.trim()
      if(!q)return
      const resultsEl=document.getElementById("searchResults")
      resultsEl.innerHTML='<div class="loading">Searching...</div>'
      resultsEl.classList.add("show")
      try{
        const res=await fetch(`/song-details?search=${encodeURIComponent(q)}`)
        const data=await res.json()
        const tracks=normalizeTracks(data)
        if(!tracks.length){
          resultsEl.innerHTML='<div class="loading">No results found.</div>'
          return
        }
        resultsEl.innerHTML=""
        tracks.slice(0,10).forEach(track=>{
          const title=getFirstTruthy(trackField(track,"title"),trackField(track,"name"),"")
          const artist=getFirstTruthy(trackField(track,"artist"),trackField(track,"artists"),"")
          const album=getFirstTruthy(trackField(track,"album"),"")
          const thumb=getFirstTruthy(trackField(track,"thumbnail"),trackField(track,"image"),trackField(track,"cover"),"https://via.placeholder.com/100?text=Spotify")
          const url=getFirstTruthy(trackField(track,"url"),trackField(track,"link"),trackField(track,"href"),"")
          const item=document.createElement("div")
          item.className="result-item"
          item.innerHTML=`
            <img src="${thumb}" alt="${title}">
            <div class="result-item-info" style="flex:1;">
              <h3>${title}</h3>
              <p>${artist}${album?(" â€¢ "+album):""}</p>
            </div>
            <button class="btn secondary">To Download</button>
            <button class="btn">Open</button>
          `
          const btns=item.querySelectorAll("button")
          btns[0].onclick=()=>{
            document.getElementById("downloadUrlInput").value=url
            lastDownloadLink=""
            showDownloadStatus("URL pasted. Tap Download.",true)
            setActiveView("downloadView")
          }
          btns[1].onclick=()=>{if(url)window.open(url,"_blank")}
          resultsEl.appendChild(item)
        })
      }catch(e){
        console.error(e)
        resultsEl.innerHTML='<div class="loading">Error searching. Try again.</div>'
      }
    })

    document.getElementById("searchInput").addEventListener("keydown",e=>{
      if(e.key==="Enter")document.getElementById("searchButton").click()
    })

    function buildDownloadLink(url){
      return `/Spotify/download?url=${encodeURIComponent(url)}`
    }

    document.getElementById("downloadBtn").addEventListener("click",()=>{
      const url=document.getElementById("downloadUrlInput").value.trim()
      if(!url){
        lastDownloadLink=""
        showDownloadStatus("Paste a Spotify URL first.",true)
        return
      }
      lastDownloadLink=buildDownloadLink(url)
      showDownloadStatus("Opening download...",true)
      window.open(lastDownloadLink,"_blank")
    })

    document.getElementById("openDownloadBtn").addEventListener("click",()=>{
      if(!lastDownloadLink){
        const url=document.getElementById("downloadUrlInput").value.trim()
        if(!url){
          showDownloadStatus("Paste a Spotify URL first.",true)
          return
        }
        lastDownloadLink=buildDownloadLink(url)
      }
      window.open(lastDownloadLink,"_blank")
      showDownloadStatus("Opened.",true)
    })

    document.getElementById("clearDownloadBtn").addEventListener("click",()=>{
      document.getElementById("downloadUrlInput").value=""
      lastDownloadLink=""
      showDownloadStatus("",false)
    })

    document.getElementById("downloadUrlInput").addEventListener("keydown",e=>{
      if(e.key==="Enter")document.getElementById("downloadBtn").click()
    })

    document.addEventListener("DOMContentLoaded",()=>{
      initDashboard()
      setActiveView("homeView")
    })
  </script>
</body>
</html>
